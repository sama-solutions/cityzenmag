#!/bin/bash\n\n# Script d'import quotidien Twitter pour CityzenMag\n# Usage: bash scripts/import-quotidien.sh\n# Id√©al pour cron job quotidien\n\necho \"üåÖ Import Quotidien Twitter - CityzenMag\"\necho \"========================================\"\necho \"$(date '+%Y-%m-%d %H:%M:%S')\"\necho \"\"\n\n# Configuration\nSUPABASE_URL=\"https://ghpptudzucrnygrozpht.supabase.co\"\nANON_KEY=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdocHB0dWR6dWNybnlncm96cGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzYzODUsImV4cCI6MjA3MzIxMjM4NX0.nJgb0WAdzxeCmPuxb6ttatYdraLWyrA2-z89JAnXwc4\"\n\n# Fonction pour logger\nlog() {\n    echo \"[$(date '+%H:%M:%S')] $1\"\n}\n\n# Statistiques avant import\nlog \"üìä V√©rification statut actuel...\"\nTHREADS_AVANT=$(curl -s -X GET \"$SUPABASE_URL/rest/v1/threads?select=count\" \\\n    -H \"apikey: $ANON_KEY\" \\\n    -H \"Authorization: Bearer $ANON_KEY\" | jq -r '.[0].count // 0')\n\nlog \"   Threads actuels: $THREADS_AVANT\"\n\n# Import du dernier thread\nlog \"üîÑ Import du dernier thread...\"\nSTART_TIME=$(date +%s)\n\nIMPORT_RESULT=$(curl -s -X POST \"$SUPABASE_URL/functions/v1/twitter-sync\" \\\n    -H \"apikey: $ANON_KEY\" \\\n    -H \"Authorization: Bearer $ANON_KEY\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"mode\": \"latest\", \"limit\": 20}')\n\nEND_TIME=$(date +%s)\nDURATION=$((END_TIME - START_TIME))\n\n# V√©rification du r√©sultat\nif echo \"$IMPORT_RESULT\" | grep -q \"UsageCapExceeded\"; then\n    log \"‚ö†Ô∏è  Limite API Twitter atteinte\"\n    log \"   Import report√© au prochain reset\"\n    exit 0\nfi\n\nif echo \"$IMPORT_RESULT\" | grep -q \"error\"; then\n    log \"‚ùå Erreur lors de l'import\"\n    echo \"$IMPORT_RESULT\" | jq .\n    exit 1\nfi\n\nlog \"‚úÖ Import termin√© (${DURATION}s)\"\n\n# Extraction des statistiques\nNEW_THREADS=$(echo \"$IMPORT_RESULT\" | jq -r '.data.processed_threads // 0')\nNEW_TWEETS=$(echo \"$IMPORT_RESULT\" | jq -r '.data.processed_tweets // 0')\nNEW_MEDIA=$(echo \"$IMPORT_RESULT\" | jq -r '.data.processed_media // 0')\n\nlog \"üìà R√©sultats:\"\nlog \"   Nouveaux threads: $NEW_THREADS\"\nlog \"   Nouveaux tweets: $NEW_TWEETS\"\nlog \"   Nouveaux m√©dias: $NEW_MEDIA\"\n\n# Statistiques finales\nTHREADS_APRES=$(curl -s -X GET \"$SUPABASE_URL/rest/v1/threads?select=count\" \\\n    -H \"apikey: $ANON_KEY\" \\\n    -H \"Authorization: Bearer $ANON_KEY\" | jq -r '.[0].count // 0')\n\nlog \"üìä Total threads: $THREADS_APRES (+$((THREADS_APRES - THREADS_AVANT)))\"\n\n# Dernier thread import√© (si nouveau)\nif [ \"$NEW_THREADS\" -gt 0 ]; then\n    log \"üßµ Dernier thread import√©:\"\n    LATEST_THREAD=$(curl -s -X GET \"$SUPABASE_URL/rest/v1/threads?select=title,date_created&order=created_at.desc&limit=1\" \\\n        -H \"apikey: $ANON_KEY\" \\\n        -H \"Authorization: Bearer $ANON_KEY\")\n    \n    TITLE=$(echo \"$LATEST_THREAD\" | jq -r '.[0].title[0:80]')\n    DATE=$(echo \"$LATEST_THREAD\" | jq -r '.[0].date_created')\n    \n    log \"   üìÑ $TITLE...\"\n    log \"   üìÖ $DATE\"\nelse\n    log \"‚ÑπÔ∏è  Aucun nouveau thread (d√©j√† √† jour)\"\nfi\n\nlog \"üéâ Import quotidien termin√©\"\necho \"\"\n\n# Pour cron job, on peut ajouter une notification\nif [ \"$NEW_THREADS\" -gt 0 ]; then\n    echo \"‚úÖ SUCC√àS: $NEW_THREADS nouveau(x) thread(s) import√©(s)\"\nelse\n    echo \"‚ÑπÔ∏è  INFO: Aucun nouveau contenu\"\nfi"
  }
]